<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flask Web Form Example</title>
</head>
<body>
    <h2>CUSTOMER INFORMATION</h2>

    <!-- Add New Customer button -->
    <form action="/newCustomer" method="get" style="margin-bottom: 20px;">
        <button type="submit">Add new customer</button>
    </form>

    <!-- Upload Excel form -->
    <form action="/import_excel" method="post" enctype="multipart/form-data" style="margin-bottom: 20px;">
        <input type="file" name="file" accept=".xlsx" required>
        <button type="submit">Upload Excel File</button>
    </form>

    <!-- Invoice Date button -->
    <label for="globalInvoiceDate"><strong>Select Invoice Date:</strong></label>
    <input type="date" id="globalInvoiceDate" name="globalInvoiceDate" required>
    <br><br>

    <a href="{{ url_for('paymentStatus') }}">View Payment Status</a>

    <!-- Customers table with individual invoice forms -->
<form method="POST" action="/update_customers">
  <table>
    <thead>
      <tr>
        <th>Actions</th>
        <th>Name</th>
        <th>Email</th>
        <th>Store Count</th>
        <th>Rate</th>
        <th>Payment Term</th>
        <th>Current PO</th>
        <th>Total</th>
        <th>Multiplier</th>
      </tr>
    </thead>
    <tbody>
      {% for cust in customers %}
      <tr>
        <td>
            <!-- NEW: Hidden date + button -->
            <input type="hidden" name="invoiceDate" class="invoiceDateInput">
            <button type="submit"
                    formaction="{{ url_for('invoiceConfirmation') }}"
                    formmethod="POST"
                    formtarget="_blank"
                    name="customer_id"
                    value="{{ cust.id }}">
            Add New Invoice
            </button>
        </td>
        <td><a href="{{ url_for('customerInfo', customer_id=cust.id) }}">{{ cust.name }}</a></td>
        <td><input type="email" name="email_{{ cust.id }}" value="{{ cust.email }}"></td>
        <td><input type="number" name="store_count_{{ cust.id }}" value="{{ cust.store_count }}"></td>
        <td><input type="text" name="rate_{{ cust.id }}" value="{{ cust.rate }}"></td>
        <td><input type="number" name="paymentTerm_{{ cust.id }}" value="{{ cust.paymentTerm }}"></td>
        <td><input type="text" name="currentPO_{{ cust.id }}" value="{{ cust.currentPO }}"></td>
        <td><input type="number" step="0.01" name="total_{{ cust.id }}" value="{{ cust.total }}"></td>
        <td><input type="number" step="0.01" name="multiplier_{{ cust.id }}" value="{{ cust.multiplier }}"></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="submit">Save Changes</button>
</form>
<script>
  // Listen for clicks on every invoice button
  document.querySelectorAll("button[type='submit'][formaction$='invoiceConfirmation']").forEach(button => {
    button.addEventListener("click", function () {
        const globalDate = document.getElementById("globalInvoiceDate").value;
        console.log("Add New Invoice clicked, globalDate is:", globalDate);

      // Find the hidden input next to this button
      const form = this.closest('form');
      const hiddenInput = form.querySelector(".invoiceDateInput");
      if (globalDate) {
        hiddenInput.value = globalDate;
        console.log("Hidden invoiceDate set to:", hiddenInput.value);
      } else {
        alert("Please select an invoice date before generating an invoice.");
        // Prevent form from submitting without a date
        event.preventDefault();
      }
    });
  });
</script>

</body>
</html>
